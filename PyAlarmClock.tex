\section{PyAlarmClock}
Pro usnadnění manipulace s budíkem připojeným přes rozhraní UART z počítače
byla vytvořena knihovna \texttt{PyAlarmClock}. Je to modul jazyka Python
obsahující abstrakce pro práci s budíkem. Programátor vytvářející počítačový
program díky tomu nemusí ani znát konkrétní příkazy prostředí
\texttt{AlarmClockCLI}. Například nastavení data času modulu RTC se provádí
přiřazením objektu \texttt{datetime.datetime} vlastnosti \verb|RTC_time|
objektu \texttt{AlarmClock} bez nutnosti znát vnitřní implementaci, která
využívá příkazu \texttt{st} pro nastavení času a \texttt{sd} pro nastavení
data.

Pro ilustraci konceptu poslouží jeden z ukázkových programů~--
\repopath{examples/set_time.py}. V následující ukázce je navíc odstraněna část
zapínající podrobné protokolování všech událostí.
\begin{lstlisting}[language=Python,style=numbers]
#!/usr/bin/env python3

import PyAlarmClock
from datetime import datetime
import time

with PyAlarmClock.SerialAlarmClock('/dev/ttyUSB0') as ac:
    ac.RTC_time = datetime.now()
    time.sleep(1.65)  # RTC is polled every 0.8 seconds
    print(ac.RTC_time)
\end{lstlisting}
Program naváže spojení s budíkem, nastaví čas uložený v RTC na aktuální čas,
počká \SI{1,65}{\second} (aby stihl firmware budíku přečíst novou hodnotu
z RTC) a vypíše do konzole čas přečtený z budíku.
\begin{lstlisting}[style=terminal]
$ ./set_time.py
2022-02-08 19:21:48
$
\end{lstlisting}


\subsection{MQTT adaptér}
Jedním z programů využívajících knihovnu \texttt{PyAlarmClock} je
\repopath{examples/mqtt_bridge.py}. Tento program umožňuje vzdálené ovládání
budíku zprávami přenášenými protokolem MQTT. Tímto způsobem lze zajistit
ovládání budíku několika programy současně bez nutnosti sdílet sériový port
mezi více procesy. Komunikace může probíhat nejen mezi více zařízeními ve
stejné počítačové síti, ale i v rámci jednoho serveru (\texttt{localhost}).

Použití adaptéru je velmi jednoduché. Příkazem \shellcmd{mqtt_bridge.py --help}
lze vypsat seznam argumentů, které lze programu předávat.
% nechci sem davat cely usage, protoze bych ho pak treba musel aktualizovat...
Následuje jednoduchý příklad -- program se připojí k MQTT brokeru na
\texttt{localhost} na výchozím portu 1883 jako uživatel \texttt{DEBUG} s heslem
zadaným interaktivně za běhu programu:
\begin{lstlisting}[style=terminal]
$ ./examples/mqtt_bridge.py /dev/ttyUSB0 -u DEBUG
Password:
2022-02-08 19:22:39,360 INFO err topic: alarmclock/err
2022-02-08 19:22:39,360 INFO state topic: alarmclock/stat
2022-02-08 19:22:39,360 INFO command topic: alarmclock/cmnd
2022-02-08 19:22:39,361 INFO Connecting to MQTT on localhost:1883
2022-02-08 19:22:42,139 INFO MQTT connected with result code 0

\end{lstlisting}

Pomocí nástrojů ze softwarového balíčku \texttt{mosquitto-clients}
% https://packages.ubuntu.com/focal/mosquitto-clients
můžeme pozorovat, že program při spuštění odešle několik zpráv:
\begin{lstlisting}[style=terminal]
$ mosquitto_sub -v -t alarmclock/#
alarmclock/stat/available online
alarmclock/stat/number_of_alarms 6
\end{lstlisting}
Číslo posílané v topic \topic{alarmclock/stat/number_of_alarms} udává počet
konfigurovatelných časů buzení, které firmware připojeného budíku podporuje
(interně zjišťováno příkazem \texttt{ver}). Zpráva je adaptérem zasílána
s příznakem \texttt{retain}, proto je automaticky zaslána nově příchozímu
subscriberovi.

Zpráva v topic \topic{alarmclock/stat/available} určuje, zda je adaptér
aktivní. Při jeho ukončení či náhodném odpojení je MQTT brokerem do tohoto
topic automaticky zaslána zpráva \texttt{offline}. K tomu je využívána funkce
MQTT Last Will and Testament -- LWT.

Požadujeme-li, aby budík provedl nějakou akci, pošleme zprávu do příslušného
\texttt{command topic} -- \topic{alarmclock/cmnd/nazev_prikazu}.
V následujícím příkladu je demonstrované rozsvícení připojeného světla
\texttt{lamp}. Vzdáleným MQTT příkazem a následné zhasnutí pomocí rozhraní na
displeji budíku. Pro přehlednost byly přidány prázdné řádky. První zpráva
v druhém bloku je příkaz pro rozsvícení lampy. V odpověď na ni přichází zpráva
v topic \topic{alarmclock/stat/lamp} značící, že byla lampa rozsvícena. Protože
firmware budíku podporuje funkci přidanou z vývojové větve
\texttt{feature/CLI-BEL}, posílá při každé změně stavu hardware na sériový port
netisknutelný ASCII znak BEL (\texttt{0x07}). V reakci na to si adaptér vyžádá
stav všech hardwarových výstupů a odešle příslušné MQTT zprávy. Zpráva o stavu
lampy je proto duplikována, je ale zajištěna zpětná kompatibilita s firmware
bez podpory funkce asynchronní detekce změn stavu hardware.
Díky této funkci je detekováno i vypnutí lampy přímo ovládacími prvky budíku,
které vede k odeslání třetího bloku zpráv.
\begin{lstlisting}[style=terminal]
$ mosquitto_sub -v -t alarmclock/#
alarmclock/stat/available online
alarmclock/stat/number_of_alarms 6

alarmclock/cmnd/lamp ON
alarmclock/stat/lamp ON
alarmclock/stat/lamp ON
alarmclock/stat/inhibit OFF
alarmclock/stat/ambient 0

alarmclock/stat/lamp OFF
alarmclock/stat/inhibit OFF
alarmclock/stat/ambient 0
\end{lstlisting}

% TODO mqtt_bridge
